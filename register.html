<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registrierung - Knödelbrot</title>
    <meta http-equiv="refresh" content="0; url=https://knödelbrot.de/wartung">
<link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400..700&family=Pacifico&display=swap" rel="stylesheet">
<style>
body {
    font-family: "DynaPuff", system-ui;
    background-color: #111;
    color: whitesmoke;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
.register-box {
    background-color: black;
    border-radius: 90px;
    padding: 40px;
    width: 380px;
    text-align: center;
    box-shadow: 0 0 20px rgba(255,255,255,0.2);
}
h1 {
    font-family: "Pacifico", cursive;
    font-size: 46px;
    color: whitesmoke;
    margin-bottom: 20px;
}
input[type="text"], input[type="password"] {
    width: 80%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 90px;
    border: none;
    background-color: #222;
    color: whitesmoke;
    font-size: 18px;
    outline: none;
}
input[type="text"]:focus, input[type="password"]:focus {
    background-color: #333;
}
button {
    background-color: black;
    color: white;
    border: none;
    border-radius: 90px;
    padding: 12px 40px;
    font-size: 20px;
    cursor: pointer;
    transition: 0.4s;
    margin-top: 15px;
}
button:hover {
    background-color: rgb(125,125,125);
    color: black;
}
#error {
    color: red;
    margin-top: 10px;
}
#message {
    color: #0f0;
    margin-top: 10px;
}
</style>
</head>
<body>

<div class="register-box">
    <h1>Registrierung</h1>
    <form id="registerForm">
        <input type="text" id="newUsername" placeholder="Benutzername" required><br>
        <input type="password" id="newPassword" placeholder="Passwort" required><br>
        <input type="text" id="bonusCode" placeholder="Bonuscode (optional)"><br>
        <button type="submit">Registrieren</button>
    </form>
    <div id="error"></div>
    <div id="message"></div>
    <p>Schon ein Konto? <a href="login.html">Login</a></p>
</div>

<script src="login_check.js"></script>

<script>
function getUsers() {
    const data = localStorage.getItem("users");
    return data ? JSON.parse(data) : {};
}

function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
}

// Hilfsfunktion Cookies setzen
function setCookie(name, value, days){
    let expires = "";
    if(days){
        const d = new Date();
        d.setTime(d.getTime() + (days*24*60*60*1000));
        expires = "; expires="+d.toUTCString();
    }
    document.cookie = name+"="+value+expires+"; path=/";
}

// Bonuscode prüfen via fetch
async function checkBonusCode(code){
    if(!code) return false; // leer → kein Bonus
    try{
        const response = await fetch("bonuscodes.txt");
        const text = await response.text();
        const lines = text.split("\n");
        const today = new Date();
        for(const line of lines){
            const [c, date] = line.split(";");
            if(c && date){
                if(c.trim() === code.trim() && today <= new Date(date.trim())){
                    return true;
                }
            }
        }
        return false;
    } catch(e){
        console.error("Bonuscode-Datei konnte nicht geladen werden");
        return false;
    }
}

document.getElementById("registerForm").addEventListener("submit", async function(e){
    e.preventDefault();

    const username = document.getElementById("newUsername").value.trim();
    const password = document.getElementById("newPassword").value;
    const bonusCode = document.getElementById("bonusCode").value.trim();

    if(!username || !password){
        document.getElementById("error").textContent = "Bitte Benutzername und Passwort eingeben!";
        return;
    }

    let users = getUsers();

    if(users[username]){
        document.getElementById("error").textContent = "Benutzername existiert bereits!";
        return;
    }

    // Bonus prüfen: jeder Benutzer kann nur **einen Code einlösen**
    let hasBonus = false;
    let appliedCode = null;
    if(bonusCode){
        const valid = await checkBonusCode(bonusCode);
        if(valid){
            hasBonus = true;
            appliedCode = bonusCode;
        }
    }

    // neuen Benutzer speichern inkl. Bonuscode
    users[username] = { 
        password: password, 
        bonus: hasBonus,
        bonusCode: appliedCode // null wenn keiner eingelöst
    };
    saveUsers(users);

    // Direkt einloggen + Cookies
    setCookie("login", "1", 7);
    setCookie("bonus", hasBonus ? "1" : "0", 7);
    setCookie("username", username, 7);

    document.getElementById("message").textContent = "✅ Registrierung erfolgreich! Du bist jetzt eingeloggt.";
    setTimeout(()=> {
        window.location.href = localStorage.getItem("redirectAfterLogin") || "index.html";
    }, 1500);
});
</script>

</body>
</html>

