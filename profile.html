<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KnödelID</title>
<link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400..700&family=Pacifico&display=swap" rel="stylesheet">
<style>
  body {
    font-family: "DynaPuff", system-ui;
    background-color: #fff;
    color: black;
    font-size: 20px;
    margin: 0;
    text-align: center;
  }

  .profile-container {
    max-width: 500px;
    margin: 50px auto;
    padding: 30px;
    border-radius: 90px;
    background-color: black;
    color: whitesmoke;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }

  h1 {
    font-family: "Pacifico", cursive;
    font-size: 46px;
    margin-bottom: 20px;
    color: black;
  }

  p {
    font-size: 20px;
  }

  input[type="text"] {
    width: 80%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 90px;
    border: none;
    background-color: #222;
    color: whitesmoke;
    font-size: 18px;
    outline: none;
  }
  input[type="text"]:focus {
    background-color: #333;
  }

  button {
    color: white;
    background-color: black;
    font-family: "DynaPuff", system-ui;
    font-size: 20px;
    border: none;
    border-radius: 90px;
    padding: 15px 32px;
    cursor: pointer;
    transition-duration: 0.4s;
    margin-top: 15px;
  }
  button:hover {
    background-color: rgb(125,125,125);
    color: black;
  }

  #message { color: #0f0; margin-top: 10px; }
  #error { color: red; margin-top: 10px; }
</style>
</head>
<body>

<div class="profile-container">
  <h1>Profil</h1>
  <p>Benutzer: <span id="usernameDisplay">–</span></p>
  <p>Aktueller Bonus: <span id="bonusDisplay">–</span></p>

  <form id="bonusForm">
    <input type="text" id="bonusCode" placeholder="Neuen Bonuscode eingeben"><br>
    <button type="submit">Bonuscode einlösen</button>
  </form>
  <div id="message"></div>
  <div id="error"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getBonusType } from "./bonuscodes.js"; // gleiche Funktion wie in register

const firebaseConfig = {
  apiKey: "AIzaSyBmnEMGPec-dzIANP0pvGT3Lbvm51zFjaY",
  authDomain: "auth.knödelbrot.de",
  projectId: "knödelbrot-1d1de"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function setCookie(name, value, days = 7) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${value}; path=/; domain=.knödelbrot.de; Secure; SameSite=None; expires=${d.toUTCString()}`;
}

const usernameSpan = document.getElementById("usernameDisplay");
const bonusSpan = document.getElementById("bonusDisplay");
const messageDiv = document.getElementById("message");
const errorDiv = document.getElementById("error");

// Persistent Login
onAuthStateChanged(auth, async (user) => {
  if(user) {
    const username = user.email.split("@")[0];
    usernameSpan.textContent = username;

    const docSnap = await getDoc(doc(db, "users", username));
    let bonus = "none";
    if(docSnap.exists()) bonus = docSnap.data().bonus;
    bonusSpan.textContent = bonus;

    // Cookies aktualisieren
    setCookie("login", "1");
    setCookie("username", username);
    setCookie("bonus", bonus);
  } else {
    errorDiv.textContent = "Nicht angemeldet! Bitte zuerst einloggen.";
  }
});

// Bonuscode einlösen
document.getElementById("bonusForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const bonusCode = document.getElementById("bonusCode").value.trim();
  if(!bonusCode) return;

  const user = auth.currentUser;
  if(!user) {
    errorDiv.textContent = "Nicht angemeldet!";
    return;
  }

  const username = user.email.split("@")[0];
  const newBonus = getBonusType(bonusCode);

  try {
    await updateDoc(doc(db, "users", username), { bonus: newBonus });
    bonusSpan.textContent = newBonus;
    setCookie("bonus", newBonus);
    messageDiv.textContent = `✅ Bonuscode eingelöst: ${newBonus}`;
    errorDiv.textContent = "";
  } catch(err) {
    console.error(err);
    errorDiv.textContent = "Fehler beim Einlösen des Bonuscodes!";
    messageDiv.textContent = "";
  }
});
</script>
</body>
</html>
